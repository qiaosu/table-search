
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Knockout : Simple list example</title>

    <link rel="stylesheet" type="text/css" href="http://assets.stable.alipay.net/financeprod/??/financeprod.financing-1.0-financing-src.css" />
    <link rel="stylesheet" type="text/css" href="static/styles.css" />
    
</head>
<body>
    <div id="wrapper">
        <div class="content">
            <h1>Live example</h1>
            <div class="search-box" id="searchView">
                <form id="searchForm">
                    <table>
                        <colgroup>
                            <col width="36%" />
                            <col width="25%" />
                            <col width="25%" />
                            <col width="14%" />
                        </colgroup>
                        <tr>
                            <td class="form-item">
                                Title: 
                                <input data-bind="value: data.title" class="mi-input" name="title" />
                            </td>
                            <td class="form-item">
                                date start: 
                                <input data-bind="value: data.dateStart" class="mi-input mi-input-date" data-type="date" name="dateStart" value="2012.05.17" />
                            </td>
                            <td class="form-item">
                                date end: 
                                <input data-bind="value: data.dateEnd" class="mi-input mi-input-date" data-type="date" name="dateEnd" value="2012.05.19" />
                            </td>
                            <td class="form-item">
                                <span class="mi-button mi-button-sblue">
                                    <button type='submit' class="mi-button-text">Search</button>
                                </span>
                            </td>
                        </tr>
                    </table>
                </form>
            </div>
            <div class="cache-box">
                <label for="cacheData">Random cache:</label><br/>
                <textarea name="cacheData" id="cacheData" rows="7" cols="160" readonly="readonly"></textarea>
            </div>
            <div class="data-box"></div>
            <div id="cal_cantainer1"></div>
        </div>
    </div>
<script type="text/javascript" charset="utf-8">
    araleConfig = {
        combo_host: 'http://assets.dev.alipay.net',
        combo_path: '/ar/??'
    }
</script>
<script type="text/javascript" src="http://assets.dev.alipay.net/ar/arale.core-1.1.js"></script>
<script type="text/javascript" src="http://assets.dev.alipay.net/ar/aralex.validator.ClassicValidator-1.4-index.js"></script>
<script type="text/javascript" src="http://assets.dev.alipay.net/ar/aralex.calendar-1.4-index.js"></script>
<script type="text/javascript" src="static/knockout-2.2.0.debug.js"></script>
<script type="text/javascript" src="static/json2.js"></script>
<script type='text/javascript'>
/*<![CDATA[*/
    var utils = window.utils || {};
    utils.randStr = function(n, u){
        var tmStr = "abcdefghijklmnopqrstuvwxyz0123456789";
        var Len = tmStr.length;
        var Str = "";
        for (i = 1; i < n + 1; i++) {
            Str += tmStr.charAt(Math.random() * Len);
        }
        return (u ? Str.toUpperCase() : Str);
    };

    utils.dateFormat = (function(){
        //private
        var token = /d{1,4}|m{1,4}|yy(?:yy)?|([HhMsTt])\1?|[LloSZ]|"[^"]*"|'[^']*'/g, timezone = /\b(?:[PMCEA][SDP]T|(?:Pacific|Mountain|Central|Eastern|Atlantic) (?:Standard|Daylight|Prevailing) Time|(?:GMT|UTC)(?:[-+]\d{4})?)\b/g, timezoneClip = /[^-+\dA-Z]/g, pad = function(val, len){
            val = String(val);
            len = len || 2;
            while (val.length < len) 
                val = "0" + val;
            return val;
        }, masks = {
            "default": "ddd mmm dd yyyy HH:MM:ss",
            shortDate: "m/d/yy",
            mediumDate: "mmm d, yyyy",
            longDate: "mmmm d, yyyy",
            fullDate: "dddd, mmmm d, yyyy",
            shortTime: "h:MM TT",
            mediumTime: "h:MM:ss TT",
            longTime: "h:MM:ss TT Z",
            isoDate: "yyyy-mm-dd",
            isoTime: "HH:MM:ss",
            isoDateTime: "yyyy-mm-dd'T'HH:MM:ss",
            isoUtcDateTime: "UTC:yyyy-mm-dd'T'HH:MM:ss'Z'"
        };
        i18n = {
            dayNames: ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"],
            monthNames: ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec", "January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"]
        };
    
        // Regexes and supporting functions are cached through closure
        return function(date, mask, utc){
        
            // You can't provide utc if you skip other args (use the "UTC:" mask prefix)
            if (arguments.length == 1 && Object.prototype.toString.call(date) == "[object String]" && !/\d/.test(date)) {
                mask = date;
                date = undefined;
            }
            
            // Passing date through Date applies Date.parse, if necessary
            date = date ? new Date(date) : new Date;
            if (isNaN(date)) 
                throw SyntaxError("invalid date");
            
            mask = String(masks[mask] || mask || masks["default"]);
            
            // Allow setting the utc argument via the mask
            if (mask.slice(0, 4) == "UTC:") {
                mask = mask.slice(4);
                utc = true;
            }
            
            var _ = utc ? "getUTC" : "get", d = date[_ + "Date"](), D = date[_ + "Day"](), m = date[_ + "Month"](), y = date[_ + "FullYear"](), H = date[_ + "Hours"](), M = date[_ + "Minutes"](), s = date[_ + "Seconds"](), L = date[_ + "Milliseconds"](), o = utc ? 0 : date.getTimezoneOffset(), flags = {
                d: d,
                dd: pad(d),
                ddd: i18n.dayNames[D],
                dddd: i18n.dayNames[D + 7],
                m: m + 1,
                mm: pad(m + 1),
                mmm: i18n.monthNames[m],
                mmmm: i18n.monthNames[m + 12],
                yy: String(y).slice(2),
                yyyy: y,
                h: H % 12 || 12,
                hh: pad(H % 12 || 12),
                H: H,
                HH: pad(H),
                M: M,
                MM: pad(M),
                s: s,
                ss: pad(s),
                l: pad(L, 3),
                L: pad(L > 99 ? Math.round(L / 10) : L),
                t: H < 12 ? "a" : "p",
                tt: H < 12 ? "am" : "pm",
                T: H < 12 ? "A" : "P",
                TT: H < 12 ? "AM" : "PM",
                Z: utc ? "UTC" : (String(date).match(timezone) || [""]).pop().replace(timezoneClip, ""),
                o: (o > 0 ? "-" : "+") + pad(Math.floor(Math.abs(o) / 60) * 100 + Math.abs(o) % 60, 4),
                S: ["th", "st", "nd", "rd"][d % 10 > 3 ? 0 : (d % 100 - d % 10 != 10) * d % 10]
            };
            
            return mask.replace(token, function($0){
                return $0 in flags ? flags[$0] : $0.slice(1, $0.length - 1);
            });
        };
    })();

    // For convenience...
    Date.prototype.format = function(mask, utc){
        return utils.dateFormat(this, mask, utc);
    };

    utils.randDate = function(s, e){
        var range = 0, int;
        s = new Date(s.replace('.', '/'));
        e = new Date(e.replace('.', '/'));
        range = e - s;
        int = Math.floor(Math.random() * range);
        return new Date(s.valueOf() + int);
    };

    utils.mockdata = function(num, data) {
        var output = [], i = 0, cell;
        num = parseInt(num, 10);
        if (!num) { alert('Type Error: Mockdata Method!');return false; }
        for (;i<num;i++) {
            cell = {};
            cell['index'] = i;
            cell['title'] = data['title'] + utils.randStr(8);
            cell['date'] = utils.randDate(data['dateStart'], data['dateEnd']);
            cell['date'].format("yyyy.mm.dd")
            output.push(cell);
        }
        return output;
    };

    var Router = {
        /* 组装数据 */
        assemble: function(){

        },
        /* 拆分数据 */
        split: function(){

        },
        post: function(){}
    };

    var SearchModel = function(){
        var settings = {
            url: '',
            method: 'post'
        }
        this.data = {
            title: ko.observable(""),
            dateStart: ko.observable($$('input[name="dateStart"]')[0].attr('value')),
            dateEnd: ko.observable($$('input[name="dateEnd"]')[0].attr('value'))
        };
        this.search = function(tgt){
            var data = {
                title: this.data.title(),
                dateStart: this.data.dateStart(),
                dateEnd: this.data.dateEnd()
            }
            var mock = utils.mockdata(Math.random()*50+5, data);
            mock = mock.map(function(item){return JSON.stringify(item);})
            $('cacheData').setHtml(mock.join(','));
        }.bind(this);
    };

    var searchModel = new SearchModel();

    ko.applyBindings(searchModel, document.getElementById('searchView'));

    var DataModel = function(arr){
        this.data = ko.observableArray(arr);
        this.render = function(){

        }
    };

    E.domReady(function(){
        var dc = null, minDate = "2012.5.1", maxDate = "2012.5.31";
        Loader.use('aralex.calendar', function() {
            dc = new aralex.calendar.Calendar({
                srcId : 'cal_cantainer1',
                week_start : '7',
                selected : [minDate,maxDate],
                afterDoSelectEvent : function(date){},
                mindate : minDate,
                maxdate : maxDate,
                date_delimiter : ".",
                dropfilter : true
            });
            dc.dateField = null;
            dc.render();

            dc.after("doSelectEvent",function(date){
                if(this.dateField){
                    this.dateField.attr("value", date);

                    var name = this.dateField.attr("name");
                    searchModel.data[name] = ko.observable(date)
                }
                this.hide();
                this.dateField = null;
            });

        });

        A($$(".mi-input")).each(function(input, index){
            if(input.attr("data-type") == "date"){
                
                /** 阻止body的click事件 */
                E.on(input, "click", function(e){e.stopEvent();});

                E.on(input, "focus", function(e){
                    var pos = D.getOffsets(e.currentTarget);
                   /** 修改ie系列下面的垂直距离 */
                    if(arale.browser.name == "ie"){
                        pos.top += 2;
                    }
                    dc.dateField = input;
                    if(input.attr("value") != ''){
                        /** 以下三个属性均需要设置, 方便用户及时的显示当前日期。 */
                        dc.attr("mindate", minDate);
                        dc.attr("maxdate", maxDate);
                        dc.attr("pagedate", input.attr("value"));
                        dc.select(input.attr("value"));
                    }
                    dc.show();
                    dc.setPosition(pos.left, pos.top + 26);
                });
            }
        });

        E.on(document.body, "click", function(e){
            if (!$(e.target).hasClass('filterchange')) {
                dc && dc.hide();
            }
        })

        Loader.use('aralex.validator.ClassicValidator', function() {
            var validator = new aralex.validator.ClassicValidator({
                itemClass: "form-item",
                notifyClass: "mi-form-explain",
                errorClass: "mi-form-item-error",
                hoverClass: "mi-form-item-hover",
                focusClass: "mi-form-item-focus",
                formId: "searchForm",
                triggerMethod: [/*"keyup", "focus", "blur"*/"blur"],
                //checkNull:true,
                rules: {
                    "input[name='title']" : {
                        type: ['requiredText'],
                        desc: "title"
                    },
                    "input[name='dateStart']" : {
                        type: ['requiredText'],
                        desc: "start date"
                    },
                    "input[name='dateEnd']" : {
                        type: ['requiredText'],
                        desc: "end date"
                    }
                },
                afterValidate: function() {
                },
                afterValidateAll: function(isValidate) {
                    if (!isValidate) {
                        return false;
                    }
                    searchModel.search();
                },
                onSuccess: function() {
                },
                onFail: function() {
                },
                checkOnSubmit: true,
                stopSubmit: true,
                beforeSubmit: function(){
                    console.log('submit');
                }
            });
        });
    });
/*]]>*/</script>
</body>
</html>